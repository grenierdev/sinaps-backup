{% import 'sinaps.admin/components/fields.html' as fields %}

{% macro langSwitcher() %}

	{% if sinaps.config.languages.length > 1 %}
		{% set opts = [] %}
		{% for lang in sinaps.config.languages %}
			{% set opts = opts|merge({value: lang, label: lang}) %}
		{% endfor %}

		{{ fields.field({
			type: 'selectbox',
			name: 'lang-switcher',
			label: 'Languages',
			options: opts
		}) }}
	{% endif %}
{% endmacro %}

{% macro layoutSwitcher(schema, currentLayout) %}

	{% set layouts = [] %}
	{% for layout in schema.layouts %}
		{% set layouts = layouts|merge({
			value: layout.handle,
			label: layout.label|default(layout.name)
		}) %}
	{% endfor %}

	{{ fields.field({
		type: 'selectbox',
		name: 'layout',
		value: currentLayout,
		label: 'Layout',
		options: layouts,
		required: true
	}) }}
{% endmacro %}

{% macro fields(fields, model) %}
	{% for field in tab.fields %}
		{% set fieldtype = sinaps.require('sinaps.admin').getFieldType(field.input) %}
		{% if fieldtype %}
			{% if field.lang %}
				{% for lang in sinaps.config.languages %}
					<div data-lang="{{ lang }}">
						{% set field = field|merge({
							id: field.handle + '[' + lang + ']',
							name: field.handle + '[' + lang + ']',
							value: model.get(field.handle + '.' + lang),
							locale: lang
						}) %}
						{{ fieldtype.getFieldHTML(field) }}
					</div>
				{% endfor %}
			{% else %}
				{% set field = field|merge({
					id: field.handle,
					name: field.handle,
					value: model.get(field.handle)
				}) %}
				{{ fieldtype.getFieldHTML(field) }}
			{% endif %}
		{% else %}
			<div class="alert alert-danger">
				Unkown {{ field.input }}
			</div>
		{% endif %}
	{% endfor %}
{% endmacro %}

{% macro tabs(schema, model) -%}
	{% set layoutHandle = model.get('layout')|default(schema.layouts[0].handle) %}
	{% if layoutHandle %}
		{% set layout = schema.getLayout(layoutHandle) %}
		<div class="tabs tabs-xs-horizontal no-margin">
			<nav>
				<ul class="nav">
					{% for tab in layout.tabs %}
						<li class="nav-item">
							<a class="nav-link{% if loop.first %} active{% endif %}" data-toggle="tab" href="#formTab{{ tab.handle }}" role="tab">{{ tab.label|default(tab.handle) }}</a>
						</li>
					{% endfor %}
				</ul>
			</nav>
			<main>
				<div class="tab-content">
					{% for tab in layout.tabs %}
						<div class="tab-pane{% if loop.first %} active{% endif %}" id="formTab{{ tab.handle }}" role="tabpanel">
							{{ fields(tab.fields, model) }}
						</div>
					{% endfor %}
				</div>
			</main>
		</div>
	{% endif %}
{%- endmacro %}
