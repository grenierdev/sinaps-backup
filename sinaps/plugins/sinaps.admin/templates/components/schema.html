{% import 'sinaps.admin/components/fields.html' as fields %}

{% macro langSwitcher() %}

	{% if sinaps.config.languages.length > 1 %}
		{% set opts = [] %}
		{% for lang in sinaps.config.languages %}
			{% set opts = opts|merge({value: lang, label: lang}) %}
		{% endfor %}

		{{ fields.field({
			type: 'selectbox',
			name: 'lang-switcher',
			label: 'Languages',
			options: opts
		}) }}
	{% endif %}
{% endmacro %}

{% macro layoutSwitcher(schema, currentLayout) %}

	{% set layouts = [] %}
	{% for layout in schema.layouts %}
		{% set layouts = layouts|merge({
			value: layout.handle,
			label: layout.label|default(layout.name)
		}) %}
	{% endfor %}

	{{ fields.field({
		type: 'selectbox',
		name: 'layout',
		value: currentLayout,
		label: 'Layout',
		options: layouts,
		required: true
	}) }}
{% endmacro %}

{% macro fields(fields, model) %}
	{% for field in tab.fields %}
		{% set fieldtype = pluginAdmin.getFieldType(field.input) %}
		{% if fieldtype %}
			{% if field.lang %}
				{% for lang in sinaps.config.languages %}
					<div data-lang="{{ lang }}">
						{% set field = field|merge({
							id: field.handle + '[' + lang + ']',
							name: field.handle + '[' + lang + ']',
							value: model.get(field.handle + '.' + lang)
						}) %}
						{{ fieldtype.getFieldHTML(field) }}
					</div>
				{% endfor %}
			{% else %}
				{% set field = field|merge({
					id: field.handle,
					name: field.handle,
					value: model.get(field.handle)
				}) %}
				{{ fieldtype.getFieldHTML(field) }}
			{% endif %}
		{% else %}
			<div class="alert alert-danger">
				Unkown {{ field.input }}
			</div>
		{% endif %}
	{% endfor %}
{% endmacro %}

{% macro tabs(schema, model) -%}
	{% set layoutHandle = model.get('layout')|default(schema.layouts[0].handle) %}
	{% if layoutHandle %}
		{% set layout = schema.getLayout(layoutHandle) %}
		{% set pluginAdmin = sinaps.require('sinaps.admin') %}

		<div class="tabbable-line">
			<ul class="nav nav-tabs">
				{% for tab in layout.tabs %}
					<li {% if loop.first %}class="active"{% endif %}>
						<a href="#form_tab_{{ tab.handle }}" data-toggle="tab">
							{{ tab.label|default(tab.handle) }}
						</a>
					</li>
				{% endfor %}
			</ul>
			<div class="tab-content">
				{% for tab in layout.tabs %}
					<div id="form_tab_{{ tab.handle }}" class="tab-pane {% if loop.first %}active{% endif %}">
						{{ fields(tab.fields, model) }}
					</div>
				{% endfor %}
			</div>
		</div>
	{% endif %}
{%- endmacro %}

{#
{% macro form(layout) %}

	<div class="tabbable-line">
		<ul class="nav nav-tabs">
			{% for tab in layout.tabs %}
				<li {% if loop.first %}class="active"{% endif %}>
					<a href="#form_tab_{{ tab.name }}" data-toggle="tab">
						{{ tab.label|default(tab.name) }}
					</a>
				</li>
			{% endfor %}
		</ul>
		<div class="tab-content">
			{% for tab in layout.tabs %}
				<div id="form_tab_{{ tab.name }}" class="tab-pane {% if loop.first %}active{% endif %}">
					<div class="form-body">
						{% for field in tab.fields %}
							{% set fieldHTML = '' %}

							{% if field.lang %}
								{% set languages = sinaps.config.languages %}
							{% else %}
								{% set languages = [''] %}
							{% endif %}

							{% for lang in languages %}

								{% if lang == '' %}
									{% set name = field.name %}
									{% set label = field.label %}
								{% else %}
									{% set name = field.name + '.' + lang %}
									{% set label = field.label + ' (' + lang|upper + ')' %}
								{% endif %}

								{% if field.input == 'text' %}
									{% set fieldHTML = fieldHTML + fields.field({
										type: 'text',
										id: 'field_' + name|replace('\.', '_', 'g'),
										name: 'field[' + name|split('.')|join('][') + ']',
										value: section.get(name),
										label: label,
										instructions: field.instructions,
										required: field.required
									}) %}
								{% else %}
									{% set fieldHTML = fieldHTML + '<input type="hidden" name="' + name +'" value="' + section.get(name)|json|escape +'" />' %}
								{% endif %}
							{% endfor %}

							{{ fieldHTML|raw }}
						{% endfor %}
					</div>
				</div>
			{% endfor %}
		</div>
	</div>

{% endmacro %}
#}
