{% extends "sinaps.admin/_frame.html" %}

{% set title = 'Sections' %}
{% set subtitle = '' %}
{% set breadcrumbs = [{
	href: '/admin/sections/',
	title: 'Sections'
},{
	href: '/admin/sections/~edit/' + section.name,
	title: 'Edit ' + section.name
}] %}

{% import 'sinaps.admin/components/schema.html' as schemaForm %}
{% import 'sinaps.admin/components/fields.html' as fields %}

{% block content %}

	<form class="" action="index.html" method="post">
		<div class="row">
			<div class="col-md-9">
				<div class="portlet light">
					<div class="portlet-body form">
						<div class="form-body">
							{# {{ schemaForm.form(schema.getLayout(section.layout)) }} #}

							{{ fields.textField({
								name: 'name',
								label: 'Name',
								instructions: 'Used as a reference key.',
								value: section.name,
								required: true,
								autofocus: true
							}) }}

							{{ fields.textField({
								name: 'title',
								label: 'Title',
								instructions: 'Only used as the title in the administration panel.',
								value: section.title,
								required: true
							}) }}

							{% for lang in sinaps.config.languages %}
								{{ fields.textField({
									name: 'url.' + lang,
									label: 'URL (' + lang|upper + ')',
									instructions: 'Optional, Nunjucks syntax allowed.',
									value: section.get('url.' + lang)
								}) }}
							{% endfor %}

							{{ fields.textField({
								name: 'template',
								label: 'Template',
								instructions: 'When URL is requested, this template will be used to render the content.',
								value: section.template
							}) }}

							<input type="hidden" name="layouts" value="{{ section.layouts|json|escape }}" />
						</div>
					</div>
				</div>
			</div>
			<div class="col-md-3">
				<div class="portlet light">
					<div class="portlet-body form">
						<div class="form-body">
							{{ schemaForm.langSwitcher() }}

							{{ schemaForm.layoutSwitcher(schema) }}
						</div>
						<div class="form-actions">
							<div class="row">
								<div class="col-md-offset-3 col-md-9">
									<button type="submit" class="btn btn-sm green">
										<i class="fa fa-check"></i>
										Save
									</button>
									<button type="reset" class="btn btn-sm default">Cancel</button>
								</div>
							</div>
						</div>
					</div>
				</div>

			</div>
		</div>
		<div class="row">
			<div class="col-md-9">

				<div class="portlet light">
					<div class="portlet-title">
						<div class="caption">
							Layouts &amp; Tabs &amp; Fields
						</div>
						<div class="actions">
							<div class="btn-toolbar">
								<div class="btn-group btn-group-sm btn-group-solid">
									<a role="create-layout" class="btn default blue" data-toggle="modal" href="#createlayout">
										<i class="fa fa-plus"></i>
									</a>
									<a role="edit-layout" class="btn default blue disabled" data-toggle="modal" href="#editlayout">
										<i class="fa fa-edit"></i>
									</a>
									<a role="delete-layout" class="btn default blue disabled" data-toggle="modal" href="#deletelayout">
										<i class="fa fa-trash-o"></i>
									</a>
								</div>
							</div>

						</div>
					</div>
					<div class="portlet-body" id="layouts">

					</div>
				</div>
			</div>
		</div>
	</form>

	<div id="createlayout" class="modal fade" tabindex="-1" role="basic" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<form>
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal" aria-hidden="true"></button>
						<h4 class="modal-title">New layout</h4>
					</div>
					<div class="modal-body">
						{{ fields.textField({
							name: 'name',
							label: 'Name',
							instructions: 'Used as a reference key.',
							required: true,
							autofocus: true
						}) }}

						{{ fields.textField({
							name: 'label',
							label: 'Label',
							instructions: 'Only used as the title in the administration panel.',
							required: true
						}) }}
					</div>
					<div class="modal-footer">
						<button type="button" class="btn default" data-dismiss="modal">Cancel</button>
						<button type="submit" class="btn blue">
							Add
						</button>
					</div>
				</form>
			</div>
		</div>
	</div><!-- createlayout -->

	<div id="editlayout" class="modal fade" tabindex="-1" role="basic" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<form>
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal" aria-hidden="true"></button>
						<h4 class="modal-title">Edit layout</h4>
					</div>
					<div class="modal-body">
						<input type="hidden" name="id" value="" />

						{{ fields.textField({
							name: 'name',
							label: 'Name',
							instructions: 'Used as a reference key.',
							required: true,
							autofocus: true
						}) }}

						{{ fields.textField({
							name: 'label',
							label: 'Label',
							instructions: 'Only used as the title in the administration panel.',
							required: true
						}) }}
					</div>
					<div class="modal-footer">
						<button type="button" class="btn default" data-dismiss="modal">Cancel</button>
						<button type="submit" class="btn blue">
							Save
						</button>
					</div>
				</form>
			</div>
		</div>
	</div><!-- editlayout -->

	<div id="deletelayout" class="modal fade" tabindex="-1" role="basic" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<form>
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal" aria-hidden="true"></button>
						<h4 class="modal-title">Remove layout</h4>
					</div>
					<div class="modal-body">
						<input type="hidden" name="id" value="" />

						Are you sure you want to remove this layout?
					</div>
					<div class="modal-footer">
						<button type="button" class="btn default" data-dismiss="modal">Cancel</button>
						<button type="submit" class="btn red">Remove</button>
					</div>
				</form>
			</div>
		</div>
	</div><!-- edittab -->

	<div id="createtab" class="modal fade" tabindex="-1" role="basic" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<form>
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal" aria-hidden="true"></button>
						<h4 class="modal-title">New tab</h4>
					</div>
					<div class="modal-body">
						<input type="hidden" name="layout" value="" />

						{{ fields.textField({
							name: 'name',
							label: 'Name',
							instructions: 'Used as a reference key.',
							required: true,
							autofocus: true
						}) }}

						{{ fields.textField({
							name: 'label',
							label: 'Label',
							instructions: 'Only used as the title in the administration panel.',
							required: true
						}) }}
					</div>
					<div class="modal-footer">
						<button type="button" class="btn default" data-dismiss="modal">Cancel</button>
						<button type="submit" class="btn blue">
							Add
						</button>
					</div>
				</form>
			</div>
		</div>
	</div><!-- createtab -->

	<div id="edittab" class="modal fade" tabindex="-1" role="basic" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<form>
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal" aria-hidden="true"></button>
						<h4 class="modal-title">Edit tab</h4>
					</div>
					<div class="modal-body">
						<input type="hidden" name="layout" value="" />
						<input type="hidden" name="id" value="" />

						{{ fields.textField({
							name: 'name',
							label: 'Name',
							instructions: 'Used as a reference key.',
							required: true,
							autofocus: true
						}) }}

						{{ fields.textField({
							name: 'label',
							label: 'Label',
							instructions: 'Only used as the title in the administration panel.',
							required: true
						}) }}
					</div>
					<div class="modal-footer">
						<button type="button" class="btn default" data-dismiss="modal">Cancel</button>
						<button type="submit" class="btn blue">
							Save
						</button>
					</div>
				</form>
			</div>
		</div>
	</div><!-- edittab -->

	<div id="deletetab" class="modal fade" tabindex="-1" role="basic" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<form>
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal" aria-hidden="true"></button>
						<h4 class="modal-title">Remove tab</h4>
					</div>
					<div class="modal-body">
						<input type="hidden" name="layout" value="" />
						<input type="hidden" name="id" value="" />

						Are you sure you want to remove this tab?
					</div>
					<div class="modal-footer">
						<button type="button" class="btn default" data-dismiss="modal">Cancel</button>
						<button type="submit" class="btn red">Remove</button>
					</div>
				</form>
			</div>
		</div>
	</div><!-- edittab -->

	<div id="formfield" class="modal fade" tabindex="-1" role="basic" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<form>
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal" aria-hidden="true"></button>
						<h4 class="modal-title">New field</h4>
					</div>
					<div class="modal-body">

					</div>
					<div class="modal-footer">
						<button type="button" class="btn default" data-dismiss="modal">Cancel</button>
						<button type="submit" class="btn blue">
							Add
						</button>
					</div>
				</form>
			</div>
		</div>
	</div><!-- createlayout -->

	<div id="deletefield" class="modal fade" tabindex="-1" role="basic" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<form>
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal" aria-hidden="true"></button>
						<h4 class="modal-title">Remove field</h4>
					</div>
					<div class="modal-body">
						<input type="hidden" name="layout" value="" />
						<input type="hidden" name="tab" value="" />
						<input type="hidden" name="id" value="" />

						Are you sure you want to remove this field?
					</div>
					<div class="modal-footer">
						<button type="button" class="btn default" data-dismiss="modal">Cancel</button>
						<button type="submit" class="btn red">Remove</button>
					</div>
				</form>
			</div>
		</div>
	</div><!-- deletefield -->

{% endblock %}

{% block footJS %}
	<link href="/admin/resources/plugins/jquery-ui/jquery-ui.min.css" rel="stylesheet" type="text/css"/>
	<script src="/admin/resources/plugins/jquery-ui/jquery-ui.min.js" type="text/javascript"></script>

	<script type="text/x-template" name="layouts">
		{% raw %}
			<div class="tabbable-line">
				<ul class="nav nav-tabs">
					<li>
						<a>
							Layouts
						</a>
					</li>
					{% for layout in layouts %}
						<li {% if layout.active %}class="active"{% endif %}>
							<a href="#tab_{{ layout.name }}" data-toggle="tab" aria-expanded="true" data-layout="{{ layout.name }}">
								{{layout.label}}
							</a>
						</li>
					{% endfor %}
				</ul>
				<div class="tab-content">
					{% for layout in layouts %}
						<div id="tab_{{ layout.name }}" class="tab-pane {% if layout.active %}active{% endif %}">
							<div class="row">
								<div class="col-xs-3">
									<ul class="nav nav-tabs tabs-left">
										<li>
											<a>
												Tabs
											</a>
										</li>
										{% for tab in layout.tabs %}
											<li {% if tab.active %}class="active"{% endif %}>
												<a href="#tab_{{ layout.name }}_{{ tab.name }}" data-toggle="tab" aria-expanded="true" data-layout="{{ layout.name }}" data-tab="{{ tab.name }}">
													{{tab.label}}
												</a>
											</li>
										{% endfor %}
									</ul>

									<div class="btn-toolbar">
										<div class="btn-group btn-group-sm btn-group-solid">
											<a role="create-tab" class="btn default purple" data-toggle="modal" href="#createtab" data-layout="{{ layout.name }}">
												<i class="fa fa-plus"></i>
											</a>
											<a role="edit-tab" class="btn default purple {% if layout.tabs.length == 0 %}disabled{% endif %}" data-toggle="modal" href="#edittab" data-layout="{{ layout.name }}">
												<i class="fa fa-edit"></i>
											</a>
											<a role="delete-tab" class="btn default purple {% if layout.tabs.length == 0 %}disabled{% endif %}" data-toggle="modal" href="#deletetab" data-layout="{{ layout.name }}">
												<i class="fa fa-trash-o"></i>
											</a>
										</div>
									</div>
								</div>
								<div class="col-xs-9">
									<div class="tab-content">
										{% for tab in layout.tabs %}
											<div id="tab_{{ layout.name }}_{{ tab.name }}" class="tab-pane {% if tab.active %}active{% endif %}">
												<table class="table table-hover">
													<thead>
														<tr>
															<th width="1"></th>
															<th>Title</th>
															<th>Type</th>
															<th></th>
														</tr>
													</thead>
													<tbody>
														{% for field in tab.fields %}
															<tr>
																<td><i class="fa fa-reorder"></i></td>
																<td>{{ field.label }} ({{ field.name }})</td>
																<td>{{ field.type }}:{{ field.input }}</td>
																<td class="text-nowrap text-right">
																	<a role="edit-field" class="btn btn-xs default yellow" data-toggle="modal" href="#formfield" data-action="edit" data-layout="{{ layout.name }}" data-tab="{{ tab.name }}" data-field="{{ field.name }}">
																		<i class="fa fa-edit"></i>
																	</a>
																	<a class="btn btn-xs default yellow" data-toggle="modal" href="#deletefield" data-layout="{{ layout.name }}" data-tab="{{ tab.name }}" data-field="{{ field.name }}">
																		<i class="fa fa-trash-o"></i>
																	</a>
																</td>
															</tr>
														{% endfor %}
													</tbody>
												</table>

												<div class="btn-group btn-group-sm btn-group-solid">
													<a role="create-tab" class="btn default yellow" data-toggle="modal" href="#formfield" data-action="create" data-layout="{{ layout.name }}" data-tab="{{ tab.name }}">
														<i class="fa fa-plus"></i>
													</a>
												</div>
											</div>
										{% endfor %}
									</div>
								</div>
							</div>
						</div>
					{% endfor %}
				</div>
			</div>
		{% endraw %}
	</script>

	<script type="text/x-template" name="field">
		{{ fields.textField({
			name: 'name',
			label: 'Name',
			instructions: 'Used as a reference key.',
			required: true,
			autofocus: true
		}) }}

		{{ fields.textField({
			name: 'label',
			label: 'Label',
			instructions: 'Only used as the title in the administration panel.',
			required: true
		}) }}

		{{ fields.textField({
			name: 'instructions',
			label: 'instructions',
			instructions: 'Shown under the field (like this)'
		}) }}

		{{ fields.checkboxField({
			name: 'lang',
			label: 'Ce champ peut être traduit'
		}) }}

		<div class="form-group form-md-line-input">
			<select class="bs-select form-control" id="input" name="{{ options.name }}" required>

			</select>
			<label for="input">Type de champ</label>
			<span class="help-block">Changing this may result in data lost</span>
		</div>
	</script>

	<script>
		$(function () {

			var state = {{ section.layouts|json }},
				$input = $(':input[name="layouts"]'),
				$layouts = $('#layouts'),
				$modalCreateLayout = $('#createlayout'),
				$modalEditLayout = $('#editlayout'),
				$modalDeleteLayout = $('#deletelayout'),
				$modalCreateTab = $('#createtab'),
				$modalEditTab = $('#edittab'),
				$modalDeleteTab = $('#deletetab'),
				$modalEditField = $('#formfield'),
				$modalDeleteField = $('#deletefield'),
				templateLayout = nunjucks.compile($('script[name="layouts"]').html()),
				templateField = nunjucks.compile($('script[name="field"]').html());

			// Initial state
			for (var a = 0, b = state.length; a < b; ++a) {
				state[a].active = a == 0;

				for (var c = 0, d = state[a].tabs.length; c < d; ++c) {
					state[a].tabs[c].active = c == 0;
				}
			}

			// Refresh layouts form
			function updateLayouts () {
				// Render
				$layouts.empty().html(templateLayout.render({
					layouts: state
				}));

				// Initialize sortables
				$layouts.find('.nav-tabs').sortable({
					items: 'li:not(:first)'
				});
				$layouts.find('.tab-pane tbody').sortable({
					handle: '.fa-reorder',
					axis: 'y',
					helper: function (e, $tr) {
						var widths = $tr.children('td').map(function () { return $(this).width(); }).get(),
							$clone = $tr.clone(false, false);
						$clone.children('td').each(function (i) {
							$(this).width(widths[i]);
						});
						return $clone;
					}
				});

				// Intercept Layout tab change
				$layouts.find('> .tabbable-line > .nav-tabs a').on('click', function (e) {
					var id = $(this).attr('href').substr(1).split('_').slice(1);
					for (var a = 0, b = state.length; a < b; ++a) {
						state[a].active = state[a].name == id[0];
					}
				});

				// Intercept Tab tab change
				$layouts.find('> .tabbable-line > .tab-content .nav-tabs a').on('click', function (e) {
					var id = $(this).attr('href').substr(1).split('_').slice(1);
					for (var a = 0, b = state.length; a < b; ++a) {
						if (state[a].name == id[0]) {
							for (var c = 0, d = state[a].tabs.length; c < d; ++c) {
								state[a].tabs[c].active = state[a].tabs[c].name == id[1];
							}
						}
					}
				});

				// Disable edit/delete if no items
				$('[role="edit-layout"], [role="delete-layout"]').toggleClass('disabled', state.length == 0);

				// Update input with current state
				var save = _.map(state, function (layout) {
					return _.extend(
						_.omit(layout, 'active', 'tabs'),
						{
							tabs: _.map(layout.tabs, function (tab) {
								return _.omit(tab, 'active');
							})
						}
					)
				});
				$input.val(JSON.stringify(save));
			}

			updateLayouts();

			// Autofocus form input
			{
				$modalCreateLayout
				.add($modalEditLayout)
				.add($modalCreateTab)
				.add($modalEditTab)
				.add($modalEditField)
					.on('show.bs.modal', function (e) {
						var $modal = $(this);
						$modal.find(':input').val('');
						setTimeout(function () {
							$modal.find(':input[autofocus]:first').focus();
						}, 500);
					});
			}

			// layout form
			{
				$modalCreateLayout.find('form').on('submit', function (e) {
					e.preventDefault();
					var $form = $(this);

					// TODO validation on name (must be unique)

					for (var a = 0, b = state.length; a < b; ++a) {
						state[a].active = false;
					}

					state.push({
						active: true,
						name: $form.find('[name="name"]').val(),
						label: $form.find('[name="label"]').val(),
						tabs: []
					});

					updateLayouts();
					$modalCreateLayout.modal('hide');
				});

				$modalEditLayout.on('show.bs.modal', function (e) {
					var $selected = $layouts.find('> .tabbable-line > .nav-tabs > li.active > a'),
						selected = [$selected.data('layout')],
						layout;

					for (var a = 0, b = state.length; a < b; ++a) {
						if (state[a].name == selected) {
							layout = state[a];
							break;
						}
					}

					if (layout) {
						$modalEditLayout.find('[name="id"]').val(layout.name);
						$modalEditLayout.find('[name="name"]').val(layout.name);
						$modalEditLayout.find('[name="label"]').val(layout.label);
					}

				});

				$modalEditLayout.find('form').on('submit', function (e) {
					e.preventDefault();
					var $form = $(this),
						id = $form.find('[name="id"]').val(),
						name = $form.find('[name="name"]').val(),
						label = $form.find('[name="label"]').val();

					// TODO validation on name (must be unique)

					for (var a = 0, b = state.length; a < b; ++a) {
						if (state[a].name == id) {
							state[a].name = name;
							state[a].label = label;
							break;
						}
					}

					updateLayouts();
					$modalEditLayout.modal('hide');
				});

				$modalDeleteLayout.on('show.bs.modal', function (e) {
					var $selected = $layouts.find('> .tabbable-line > .nav-tabs > li.active > a'),
						selected = [$selected.data('layout')],
					//var selected = $layouts.find('> .tabbable-line > .nav-tabs > li.active > a').attr('href').substr(1).split('_')[1],
						layout;

					for (var a = 0, b = state.length; a < b; ++a) {
						if (state[a].name == selected) {
							layout = state[a];
							break;
						}
					}

					if (layout) {
						$modalDeleteLayout.find('[name="id"]').val(layout.name);
					}

				});

				$modalDeleteLayout.find('form').on('submit', function (e) {
					e.preventDefault();
					var $form = $(this),
						id = $form.find('[name="id"]').val();

					state = _.filter(state, function (layout) {
						return layout.name != id;
					});
					if (state.length > 0) {
						state[0].active = true;
					}

					updateLayouts();
					$modalDeleteLayout.modal('hide');
				});
			}

			// Tab form
			{
				$modalCreateTab.on('show.bs.modal', function (e) {
					var $target = $(e.relatedTarget),
						selected = [$target.data('layout')];

					$modalCreateTab.find('[name="layout"]').val(selected[0]);
				});

				$modalCreateTab.find('form').on('submit', function (e) {
					e.preventDefault();
					var $form = $(this),
						layout = $form.find('[name="layout"]').val();

					// TODO validation on name (must be unique)

					for (var a = 0, b = state.length; a < b; ++a) {
						if (state[a].name == layout) {
							for (var c = 0, d = state[a].tabs.length; c < d; ++c) {
								state[a].tabs[c].active = false;
							}

							state[a].tabs.push({
								active: true,
								name: $form.find('[name="name"]').val(),
								label: $form.find('[name="label"]').val(),
								fields: []
							});
							break;
						}
					}

					updateLayouts();
					$modalCreateTab.modal('hide');
				});

				$modalEditTab.on('show.bs.modal', function (e) {
					var $target = $(e.relatedTarget),
						$selected = $target.closest('.tab-pane').find('.nav-tabs > li.active > a'),
						selected = [$selected.data('layout'), $selected.data('tab')],
						layout,
						tab;

					for (var a = 0, b = state.length; a < b; ++a) {
						if (state[a].name == selected[0]) {
							layout = state[a];
							for (var c = 0, d = state[a].tabs.length; c < d; ++c) {
								if (state[a].tabs[c].name == selected[1]) {
									tab = state[a].tabs[c];
									break;
								}
							}
						}
					}

					if (tab) {
						$modalEditTab.find('[name="layout"]').val(layout.name);
						$modalEditTab.find('[name="id"]').val(tab.name);
						$modalEditTab.find('[name="name"]').val(tab.name);
						$modalEditTab.find('[name="label"]').val(tab.label);
					}

				});

				$modalEditTab.find('form').on('submit', function (e) {
					e.preventDefault();
					var $form = $(this),
						layout = $form.find('[name="layout"]').val(),
						id = $form.find('[name="id"]').val(),
						name = $form.find('[name="name"]').val(),
						label = $form.find('[name="label"]').val();

					// TODO validation on name (must be unique)

					for (var a = 0, b = state.length; a < b; ++a) {
						if (state[a].name == layout) {
							for (var c = 0, d = state[a].tabs.length; c < d; ++c) {
								if (state[a].tabs[c].name == id) {
									state[a].tabs[c].name = name;
									state[a].tabs[c].label = label;
									break;
								}
							}
						}
					}

					updateLayouts();
					$modalEditTab.modal('hide');
				});

				$modalDeleteTab.on('show.bs.modal', function (e) {
					var $target = $(e.relatedTarget),
						$selected = $target.closest('.tab-pane').find('.nav-tabs > li.active > a'),
						selected = [$selected.data('layout'), $selected.data('tab')],
						layout,
						tab;

					for (var a = 0, b = state.length; a < b; ++a) {
						if (state[a].name == selected[0]) {
							layout = state[a];
							for (var c = 0, d = state[a].tabs.length; c < d; ++c) {
								if (state[a].tabs[c].name == selected[1]) {
									tab = state[a].tabs[c];
									break;
								}
							}
						}
					}

					if (tab) {
						$modalDeleteTab.find('[name="layout"]').val(layout.name);
						$modalDeleteTab.find('[name="id"]').val(tab.name);
					}

				});

				$modalDeleteTab.find('form').on('submit', function (e) {
					e.preventDefault();
					var $form = $(this),
						layout = $form.find('[name="layout"]').val(),
						id = $form.find('[name="id"]').val();

					for (var a = 0, b = state.length; a < b; ++a) {
						if (state[a].name == layout) {
							state[a].tabs = _.filter(state[a].tabs, function (tab) {
								return tab.name != id;
							});
							if (state[a].tabs.length > 0) {
								state[a].tabs[0].active = true;
							}
						}
					}

					updateLayouts();
					$modalDeleteTab.modal('hide');
				});
			}

			// Field form
			{
				$modalEditField.on('show.bs.modal', function (e) {

					console.log(templateField.render());

					$modalEditField.find('.modal-body').empty().html(templateField.render({

					}));

					$modalEditField.find('.bs-select').selectpicker({
			            iconBase: 'fa',
			            tickIcon: 'fa-check'
			        });

				});

				$modalDeleteField.on('show.bs.modal', function (e) {
					var $target = $(e.relatedTarget),
						selected = [$target.data('layout'), $target.data('tab'), $target.data('field')],
						layout,
						tab,
						field;

					for (var a = 0, b = state.length; a < b; ++a) {
						if (state[a].name == selected[0]) {
							layout = state[a];
							for (var c = 0, d = state[a].tabs.length; c < d; ++c) {
								if (state[a].tabs[c].name == selected[1]) {
									tab = state[a].tabs[c];
									for (var e = 0, f = state[a].tabs[c].fields.length; e < f; ++e) {
										if (state[a].tabs[c].fields[e].name == selected[2]) {
											field = state[a].tabs[c].fields[e];
											break;
										}
									}
								}
							}
						}
					}

					if (field) {
						$modalDeleteField.find('[name="layout"]').val(layout.name);
						$modalDeleteField.find('[name="tab"]').val(tab.name);
						$modalDeleteField.find('[name="id"]').val(field.name);
					}
				});

				$modalDeleteField.find('form').on('submit', function (e) {
					e.preventDefault();
					var $form = $(this),
						layout = $form.find('[name="layout"]').val(),
						tab = $form.find('[name="tab"]').val(),
						id = $form.find('[name="id"]').val();

					for (var a = 0, b = state.length; a < b; ++a) {
						if (state[a].name == layout) {
							for (var c = 0, d = state[a].tabs.length; c < d; ++c) {
								if (state[a].tabs[c].name == tab) {
									state[a].tabs[c].fields = _.filter(state[a].tabs[c].fields, function (field) {
										return field.name != id;
									});
								}
							}
						}
					}

					updateLayouts();
					$modalDeleteField.modal('hide');
				});
			}
		});
	</script>
{% endblock %}
